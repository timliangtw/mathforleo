import React, { useState, useEffect } from 'react';
import { User, ArrowRight, ArrowLeft, CheckCircle2, XCircle, RefreshCcw, HelpCircle } from 'lucide-react';

const QueuePractice = () => {
// 遊戲狀態
const [problem, setProblem] = useState(null);
const [userAnswer, setUserAnswer] = useState('');
const [feedback, setFeedback] = useState(null); // 'correct', 'wrong', or null
const [showExplanation, setShowExplanation] = useState(false);
const [score, setScore] = useState(0);

// 產生題目
const generateProblem = () => {
// 隨機決定題型 (1: 前後加總+1, 2: 重疊扣除-1, 3: 簡單相加)
const type = Math.floor(Math.random() * 3) + 1;

// 隨機產生數字，確保總數不要太大 (5-15之間)，適合4-8歲心算或手指算
let n1, n2, answer, questionText, explanationText;
const targetName = "小明"; // 可以改成小朋友的名字

if (type === 1) {
// 題型一：前面有 X 人，後面有 Y 人。總共幾人？ (X + Y + 1)
n1 = Math.floor(Math.random() * 5) + 1; // 前面 1-5 人
n2 = Math.floor(Math.random() * 5) + 1; // 後面 1-5 人
answer = n1 + n2 + 1;
questionText = `${targetName}去排隊，他的「前面」有 ${n1} 個人，他的「後面」有 ${n2} 個人。請問這排隊伍「總共有」幾個人？`;
explanationText = `前面 ${n1} 人 + ${targetName}自己 1 人 + 後面 ${n2} 人 = ${answer} 人`;
} else if (type === 2) {
// 題型二：從左數是第 X 個，從右數是第 Y 個。總共幾人？ (X + Y - 1)
// 總數設為 total
const total = Math.floor(Math.random() * 6) + 5; // 總數 5-10 人
n1 = Math.floor(Math.random() * (total - 1)) + 1; // 左邊數來第 n1
// 如果總數是 total，左數是 n1，則右數是 (total - n1 + 1)
n2 = total - n1 + 1;

answer = total;
questionText = `${targetName}在排隊，從「前面」數過來他是第 ${n1} 個，從「後面」數過來他是第 ${n2} 個。請問這排隊伍「總共有」幾個人？`;
explanationText = `從前面數第 ${n1} 個，從後面數第 ${n2} 個，${targetName}被數了兩次，所以要扣掉一次喔！ ${n1} + ${n2} - 1 = ${answer} 人`;
} else {
// 題型三：排第 X 個，後面還有 Y 人。總共幾人？ (X + Y)
n1 = Math.floor(Math.random() * 5) + 1; // 第 n1 個
n2 = Math.floor(Math.random() * 5) + 1; // 後面 n2 人
answer = n1 + n2;
questionText = `${targetName}排在第 ${n1} 個，他的「後面」還有 ${n2} 個人。請問這排隊伍「總共有」幾個人？`;
explanationText = `排第 ${n1} 個的意思就是包含${targetName}前面已經有 ${n1} 人了，再加上後面的 ${n2} 人，就是總人數囉！`;
}

setProblem({
type,
n1,
n2,
answer,
questionText,
explanationText,
targetName
});
setUserAnswer('');
setFeedback(null);
setShowExplanation(false);
};

// 初始化題目
useEffect(() => {
generateProblem();
}, []);

const checkAnswer = () => {
const num = parseInt(userAnswer);
if (isNaN(num)) return;

if (num === problem.answer) {
setFeedback('correct');
setScore(s => s + 1);
setShowExplanation(true); // 答對也顯示圖解加強記憶
} else {
setFeedback('wrong');
setShowExplanation(true); // 答錯顯示圖解教學
}
};

const handleKeyDown = (e) => {
if (e.key === 'Enter') {
checkAnswer();
}
};

// 視覺化圖解元件
const Visualizer = () => {
if (!problem) return null;

let items = [];
const total = problem.answer;

// 找出主角的位置 (index based 0)
let targetIndex = -1;

if (problem.type === 1) {
targetIndex = problem.n1; // 前面有 n1 人，所以主角在 index n1
} else if (problem.type === 2) {
targetIndex = problem.n1 - 1; // 第 n1 個，index 為 n1-1
} else if (problem.type === 3) {
targetIndex = problem.n1 - 1; // 第 n1 個
}

for (let i = 0; i < total; i++) { const isTarget=i===targetIndex; let label='' ; let subLabel='' ; // 標籤邏輯 if
    (problem.type===1) { if (i < targetIndex) label='前' ; if (i> targetIndex) label = '後';
    } else if (problem.type === 2) {
    // 雙重標籤
    if (i === targetIndex) {
    subLabel = `前${problem.n1}/後${problem.n2}`;
    }
    } else if (problem.type === 3) {
    if (i < targetIndex) label=`${i+1}`; if (i> targetIndex) label = '後';
        }

        items.push(
        <div key={i} className="flex flex-col items-center mx-1 animate-in fade-in zoom-in duration-300">
            <div className={`relative w-10 h-10 md:w-14 md:h-14 rounded-full flex items-center justify-center border-4
                text-2xl mb-1 shadow-sm transition-all ${isTarget
                ? 'bg-yellow-100 border-yellow-500 text-yellow-700 scale-110 z-10'
                : 'bg-white border-blue-200 text-blue-400' }`}>
                {isTarget ?
                <User size={28} strokeWidth={2.5} /> :
                <User size={20} />}

                {/* 序號標記 */}
                <div className="absolute -top-8 text-xs font-bold text-gray-400">
                    {i + 1}
                </div>
            </div>

            {/* 輔助文字 */}
            {isTarget && <span
                className="text-sm font-bold text-yellow-700 whitespace-nowrap">{problem.targetName}</span>}
            {!isTarget && label && <span className="text-xs text-blue-400">{label}</span>}
            {isTarget && subLabel && <span
                className="text-[10px] text-yellow-600 bg-yellow-50 px-1 rounded whitespace-nowrap mt-1">{subLabel}</span>}
        </div>
        );
        }

        return (
        <div className="mt-6 p-4 bg-slate-50 rounded-xl border border-slate-200 overflow-x-auto">
            <div className="text-center text-sm text-gray-500 mb-4 font-bold flex items-center justify-center gap-2">
                <HelpCircle size={16} />
                圖解小教室：數數看這裡有幾個人？
            </div>
            <div className="flex justify-center items-end min-w-max pb-2 px-4">
                {items}
            </div>

            {/* 動態解釋區塊 */}
            <div className="mt-4 text-center p-3 bg-white rounded-lg border border-yellow-100 shadow-sm">
                <p className="text-lg text-slate-700 font-bold">
                    {problem.explanationText}
                </p>
            </div>
        </div>
        );
        };

        return (
        <div className="min-h-screen bg-sky-100 flex items-center justify-center p-4 font-sans">
            <div className="max-w-2xl w-full bg-white rounded-3xl shadow-xl overflow-hidden border-4 border-white">

                {/* Header */}
                <div className="bg-sky-500 p-4 md:p-6 flex justify-between items-center text-white">
                    <div className="flex items-center gap-3">
                        <div className="bg-white/20 p-2 rounded-xl">
                            <User size={32} />
                        </div>
                        <div>
                            <h1 className="text-2xl md:text-3xl font-black tracking-wider">排隊邏輯小學堂</h1>
                            <p className="text-sky-100 text-sm">第幾 vs 有幾個，不再搞混！</p>
                        </div>
                    </div>
                    <div className="bg-white/20 px-4 py-2 rounded-full font-bold">
                        得分: {score}
                    </div>
                </div>

                {/* Content */}
                <div className="p-6 md:p-8 space-y-8">

                    {/* Question Card */}
                    <div className="bg-amber-50 rounded-2xl p-6 border-2 border-amber-100 relative">
                        <span
                            className="absolute -top-3 -left-3 bg-amber-400 text-white px-3 py-1 rounded-lg font-bold shadow-sm transform -rotate-3">
                            題目
                        </span>
                        <p className="text-2xl md:text-3xl font-bold text-slate-700 leading-relaxed text-center mt-2">
                            {problem ? problem.questionText : '載入中...'}
                        </p>
                    </div>

                    {/* Input Area */}
                    <div className="flex flex-col items-center gap-6">
                        <div className="flex items-center gap-4 w-full justify-center">
                            <input type="number" value={userAnswer} onChange={(e)=> setUserAnswer(e.target.value)}
                            onKeyDown={handleKeyDown}
                            placeholder="?"
                            className="w-32 h-20 text-center text-4xl font-bold border-4 border-slate-200 rounded-2xl
                            focus:border-sky-400 focus:outline-none focus:ring-4 focus:ring-sky-100 transition-all
                            text-slate-700 placeholder-slate-300"
                            disabled={feedback === 'correct'}
                            />
                            <span className="text-2xl font-bold text-slate-400">人</span>
                        </div>

                        {/* Action Buttons */}
                        {!feedback ? (
                        <button onClick={checkAnswer}
                            className="w-full md:w-auto px-12 py-4 bg-sky-500 hover:bg-sky-600 active:scale-95 text-white text-xl font-bold rounded-2xl shadow-lg shadow-sky-200 transition-all flex items-center justify-center gap-2">
                            <CheckCircle2 size={24} />
                            送出答案
                        </button>
                        ) : (
                        <button onClick={generateProblem}
                            className="w-full md:w-auto px-12 py-4 bg-slate-800 hover:bg-slate-700 active:scale-95 text-white text-xl font-bold rounded-2xl shadow-lg transition-all flex items-center justify-center gap-2 animate-pulse">
                            <RefreshCcw size={24} />
                            再練一題
                        </button>
                        )}
                    </div>

                    {/* Feedback & Visualization Area */}
                    {feedback && (
                    <div className={`transition-all duration-500 ease-out ${showExplanation
                        ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4' }`}>

                        {/* Result Message */}
                        <div className="flex justify-center mb-4">
                            {feedback === 'correct' ? (
                            <div
                                className="flex items-center gap-2 text-green-500 bg-green-50 px-6 py-2 rounded-full border border-green-200">
                                <CheckCircle2 size={28} />
                                <span className="text-xl font-bold">答對了！你真棒！</span>
                            </div>
                            ) : (
                            <div
                                className="flex items-center gap-2 text-red-500 bg-red-50 px-6 py-2 rounded-full border border-red-200">
                                <XCircle size={28} />
                                <span className="text-xl font-bold">再想一下喔！看看下面的圖</span>
                            </div>
                            )}
                        </div>

                        {/* The Explanation */}
                        <Visualizer />

                    </div>
                    )}

                </div>

                {/* Footer */}
                <div className="bg-slate-50 p-4 text-center text-slate-400 text-sm">
                    給爸爸媽媽的提示：引導孩子用手指著螢幕上的人數一數，建立「第幾」跟「總數」的關聯。
                </div>
            </div>
        </div>
        );
        };

        export default QueuePractice;